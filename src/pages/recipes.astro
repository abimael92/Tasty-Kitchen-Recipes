---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { client } from '../lib/sanity.js';
import RecipeList from '../components/RecipeList.jsx';

const { currentLocale } = Astro;

const localRecipes = (await getCollection('recipes')).map((entry) => ({
	...entry.data,
	id: entry.id,
	slug: entry.slug,
}));

let sanityRecipes = [];
try {
	sanityRecipes = await client.fetch(`
    *[_type == "recipe"]{
      _id,
      title,
      ingredients,
      instructions,
      "image": image.asset->url,
      "video": video.asset->url,
      "slug": slug.current
    }
  `);
} catch (e) {
	console.error('Failed to fetch Sanity recipes:', e.message);
}

const recipes = [...localRecipes, ...sanityRecipes]; // <-- merge both
const splitRegex = currentLocale?.startsWith('es')
	? /\s(y|con)\s/i
	: /\s(and|with)\s/i;
---

<BaseLayout title='Recipes'>
	<div class='header-buttons'>
		<button onclick='history.back()' class='back-button'>Back</button>
		<a href='/add-recipe' class='add-recipe-button'>
			<span class='plus-icon'>+</span> Add New Recipe
		</a>
	</div>

	<h1>Delicious Recipes</h1>

	<RecipeList client:load recipes={recipes} splitRegex={splitRegex} />
</BaseLayout>
