---
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import BaseLayout from '../layouts/BaseLayout.astro';
import { client } from '../lib/sanity.js';

const recipesDir = path.resolve('src/content/recipes');

// Load local markdown recipes
const localRecipes = fs.readdirSync(recipesDir).map((file) => {
	const filePath = path.join(recipesDir, file);
	const content = fs.readFileSync(filePath, 'utf-8');
	const { data } = matter(content);

	return {
		title: data.title,
		ingredients: data.ingredients,
		image: data.image,
		instructions: data.instructions,
	};
});

// Load Sanity recipes
let sanityRecipes = [];
try {
	sanityRecipes = await client.fetch(`
		*[_type == "recipe"]{
			_id,
			title,
			ingredients,
			instructions,
			"image": image.asset->url,
			"video": video.asset->url
		}
	`);
} catch (e) {
	console.error('Failed to fetch Sanity recipes:', e.message);
}

// Combine both
const recipes = [...localRecipes, ...sanityRecipes];
---

<BaseLayout title='Recipes'>
	<button onclick='history.back()' class='back-button'>Back</button>

	<h1>Delicious Recipes</h1>

	<div class='recipes'>
		{
			recipes.map((recipe, i) => (
				<div class='recipe' key={recipe.title || i}>
					{recipe.image && <img src={recipe.image} alt={recipe.title} />}
					<h2>{recipe.title}</h2>
					<ul>
						{(Array.isArray(recipe.ingredients)
							? recipe.ingredients
							: recipe.ingredients?.split?.('\n') || []
						).map((ingredient) => (
							<li>{ingredient}</li>
						))}
					</ul>
					<ol class='instructions'>
						{(recipe.instructions || '')
							.split('\n')
							.filter((line) => line.trim() !== '')
							.map((line) => (
								<li>{line}</li>
							))}
					</ol>

					{recipe.video && (
						<video controls width='100%'>
							<source src={recipe.video} type='video/mp4' />
						</video>
					)}
				</div>
			))
		}
	</div>
</BaseLayout>

<style>
	.back-button {
		background: #d2691e;
		color: white;
		padding: 10px 15px;
		border: none;
		border-radius: 5px;
		cursor: pointer;
		margin: 15px;
		display: inline-block;
	}

	.recipes {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 50px;
		padding: 30px 20px;
		margin: 50px;
	}

	.recipe {
		display: flex;
		flex-direction: column;
		justify-content: flex-start;
		border: 1px solid #f5c6c6;
		border-radius: 12px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.51);
		padding: 16px;
		height: 100%;
		max-height: 450px;
		overflow: hidden;
		transition: transform 0.2s ease-in-out;
	}

	.recipe:hover {
		transform: translateY(-4px);
	}

	.recipe img {
		width: 100%;
		height: 200px;
		object-fit: cover;
		border-radius: 5px;
		margin-bottom: 10px;
	}

	.recipe h2 {
		margin-top: 0;
		font-size: 1.2rem;
	}

	/* Ingredients list styles */
	.recipe ul {
		background: #fff6f6;
		border: 1px solid #ddd;
		border-radius: 8px;
		padding: 10px 15px;
		margin: 0.5rem 0 1rem;
		max-height: 130px;
		overflow-y: auto;
		box-shadow: inset 0 0 5px #f5c6c6;
		font-size: 0.95rem;
		line-height: 1.5;
		color: #5a2e2e;
		padding-left: 1.25rem;
	}

	.recipe ul li {
		padding: 4px 0;
		border-bottom: 1px solid #f0dada;
	}

	.recipe ul li:last-child {
		border-bottom: none;
	}

	/* Instructions list styles */
	.instructions {
		background: #fff6f6;
		border: 1px solid #ddd;
		border-radius: 8px;
		padding: 10px 15px;
		margin: 0.5rem 0 1rem;
		max-height: 130px;
		overflow-y: auto;
		box-shadow: inset 0 0 5px #f5c6c6;
		font-size: 0.95rem;
		line-height: 1.5;
		color: #5a2e2e;
		padding-left: 1.25rem;
	}

	/* List items for instructions */
	.instructions li {
		padding: 4px 0;
		border-bottom: 1px solid #f0dada;
	}

	.instructions li:last-child {
		border-bottom: none;
	}

	/* Scrollbar styles */
	.recipe ul::-webkit-scrollbar,
	.instructions::-webkit-scrollbar {
		width: 8px;
	}

	.recipe ul::-webkit-scrollbar-thumb,
	.instructions::-webkit-scrollbar-thumb {
		background: #f08080;
		border-radius: 12px;
		box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
	}

	.recipe ul::-webkit-scrollbar-track,
	.instructions::-webkit-scrollbar-track {
		background: #ffecec;
		border-radius: 12px;
	}

	/* Firefox scrollbar */
	.recipe ul,
	.instructions {
		scrollbar-width: thin;
		scrollbar-color: #f08080 #ffecec;
	}
</style>
